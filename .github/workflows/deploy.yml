name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Setup Node.js ⚙️
        uses: actions/setup-node@v3
        with:
          node-version: 18
          # 禁用依賴項緩存，直到我們生成 package-lock.json
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install Dependencies 📦
        run: |
          npm config set legacy-peer-deps true
          npm install --no-package-lock
          npm install --package-lock-only
          npm ci

      - name: Create Patch for NativeWind ✨
        run: |
          mkdir -p patches/nativewind@2.0.11
          cat > patches/nativewind@2.0.11/web-build-fix.patch << 'EOL'
          diff --git a/node_modules/nativewind/dist/babel/native.js b/node_modules/nativewind/dist/babel/native.js
          index df52ab8..5321e75 100644
          --- a/node_modules/nativewind/dist/babel/native.js
          +++ b/node_modules/nativewind/dist/babel/native.js
          @@ -10,7 +10,9 @@ const plugin = require("tailwindcss/plugin");
           const postcss = require("postcss");
           
           async function process(css, options) {
          -  return (await postcss([pluginCreator(options)]).process(css, { from: undefined })).css;
          +  const result = await postcss([pluginCreator(options)]).process(css, { from: undefined });
          +  return result.css;
          +  
           }
           
           function pluginCreator(options = {}) {
          EOL
          npx patch-package nativewind

      - name: Build Web 🔨
        env:
          CI: false
          PUBLIC_URL: /self-fit
        run: npm run build:web

      - name: Setup GitHub Pages Configuration 🧰
        run: |
          # Create a 404.html file for SPA routing
          cp web-build/index.html web-build/404.html
          
          # Add SPA routing script to index.html
          cat <<EOT >> web-build/index.html
          <script type="text/javascript">
            (function(l) {
              if (l.search[1] === '/' ) {
                var decoded = l.search.slice(1).split('&').map(function(s) { 
                  return s.replace(/~and~/g, '&')
                }).join('?');
                window.history.replaceState(null, null,
                    l.pathname.slice(0, -1) + decoded + l.hash
                );
              }
            }(window.location))
          </script>
          EOT

      - name: Deploy to GitHub Pages 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: web-build
          clean: true
