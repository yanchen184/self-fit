name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v3

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Dependencies ðŸ“¦
        run: |
          npm install --legacy-peer-deps
          npm install -g expo-cli

      - name: Display App Version ðŸ“‹
        run: |
          VERSION=$(node -e "console.log(require('./package.json').version)")
          echo "Building app version: $VERSION"
          
      - name: Fix NativeWind ðŸ”§
        run: |
          npm run fix-nativewind
          
      - name: Build Web ðŸ”¨
        env:
          CI: false
          PUBLIC_URL: /self-fit
          NODE_OPTIONS: --max-old-space-size=4096
        run: |
          # æª¢æŸ¥ postcss.config.js å’Œ webpack.config.js æ˜¯å¦å­˜åœ¨
          if [ ! -f "postcss.config.js" ]; then
            echo "Creating missing postcss.config.js"
            cat > postcss.config.js << 'EOL'
module.exports = {
  plugins: {
    'nativewind/postcss': {
      async: true,
    },
    tailwindcss: {},
    autoprefixer: {},
  },
};
EOL
          fi

          # ä½¿ç”¨ npm è…³æœ¬æ§‹å»º
          echo "é–‹å§‹æ§‹å»º Web ç‰ˆæœ¬..."
          npm run build:web || (echo "æ§‹å»ºå¤±æ•—ï¼Œå˜—è©¦ç›´æŽ¥ä½¿ç”¨ expo export:web å‘½ä»¤" && CI=false PUBLIC_URL=/self-fit expo export:web)
          
          # æª¢æŸ¥æ§‹å»ºçµæžœ
          if [ ! -d "web-build" ]; then
            echo "web-build ç›®éŒ„ä¸å­˜åœ¨ï¼Œå˜—è©¦ä½¿ç”¨å‚™ç”¨æ§‹å»ºæ–¹å¼"
            NODE_OPTIONS=--max-old-space-size=8192 CI=false PUBLIC_URL=/self-fit expo export --platform web
          fi

      - name: Check Web Build Directory ðŸ”
        run: |
          if [ ! -d "web-build" ] || [ ! -f "web-build/index.html" ]; then
            echo "Web build failed or directory is missing!"
            ls -la
            exit 1
          else
            echo "Web build successful!"
            ls -la web-build/
          fi

      - name: Add Version to Web Build ðŸ·ï¸
        run: |
          VERSION=$(node -e "console.log(require('./package.json').version)")
          # æ·»åŠ ç‰ˆæœ¬è™Ÿåˆ° index.html
          sed -i "s|</head>|<meta name=\"app-version\" content=\"$VERSION\" />\n<script>window.APP_VERSION = '$VERSION';</script>\n</head>|" web-build/index.html
          echo "Added version $VERSION to web build"

      - name: Setup GitHub Pages Configuration ðŸ§°
        run: |
          # Create a 404.html file for SPA routing
          cp web-build/index.html web-build/404.html
          
          # Add SPA routing script to index.html
          cat <<EOT >> web-build/index.html
          <script type="text/javascript">
            (function(l) {
              if (l.search[1] === '/' ) {
                var decoded = l.search.slice(1).split('&').map(function(s) { 
                  return s.replace(/~and~/g, '&')
                }).join('?');
                window.history.replaceState(null, null,
                    l.pathname.slice(0, -1) + decoded + l.hash
                );
              }
            }(window.location))
          </script>
          EOT

      - name: Deploy to GitHub Pages ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: web-build
          clean: true
