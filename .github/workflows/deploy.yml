name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3

      - name: Setup Node.js ‚öôÔ∏è
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Dependencies üì¶
        run: |
          npm install --legacy-peer-deps

      - name: Modify NativeWind Source Code üîß
        run: |
          NATIVE_FILE=node_modules/nativewind/dist/babel/native.js
          if [ -f "$NATIVE_FILE" ]; then
            # Create a backup
            cp $NATIVE_FILE ${NATIVE_FILE}.backup
            
            # Fix the async issue in process() function
            sed -i 's/async function process(css, options) {/async function process(css, options) {\n  try {/' $NATIVE_FILE
            sed -i 's/return (await postcss(\[pluginCreator(options)\]).process(css, { from: undefined })).css;/const result = await postcss([pluginCreator(options)]).process(css, { from: undefined });\n    return result.css;\n  } catch (error) {\n    console.error("Error processing CSS:", error);\n    throw error;\n  }/' $NATIVE_FILE
            
            echo "Modified NativeWind source successfully"
          else
            echo "NativeWind file not found at $NATIVE_FILE"
            ls -la node_modules/nativewind/dist/babel/ || echo "Directory not found"
          fi

      - name: Build Web üî®
        env:
          CI: false
          PUBLIC_URL: /self-fit
        run: npm run build:web || npm run build:web

      - name: Setup GitHub Pages Configuration üß∞
        run: |
          # Create a 404.html file for SPA routing
          if [ -d "web-build" ]; then
            cp web-build/index.html web-build/404.html
            
            # Add SPA routing script to index.html
            cat <<EOT >> web-build/index.html
          <script type="text/javascript">
            (function(l) {
              if (l.search[1] === '/' ) {
                var decoded = l.search.slice(1).split('&').map(function(s) { 
                  return s.replace(/~and~/g, '&')
                }).join('?');
                window.history.replaceState(null, null,
                    l.pathname.slice(0, -1) + decoded + l.hash
                );
              }
            }(window.location))
          </script>
          EOT
          else
            echo "web-build directory not found. Build may have failed."
            ls -la
          fi

      - name: Deploy to GitHub Pages üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: web-build
          clean: true
